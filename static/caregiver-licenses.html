<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>證照管理 - CareFinder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="/static/css/output.css" rel="stylesheet">
</head>

<body class="bg-gray-50">
    <nav class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-8">
                    <a href="/dashboard.html" class="text-2xl font-bold text-primary-600">CareFinder</a>
                    <div data-nav-menu class="flex space-x-4">
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="authAPI.logout()"
                        class="text-gray-700 hover:text-primary-600 px-3 py-2 rounded-md text-sm font-medium">登出</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold text-gray-800">證照管理</h2>
            <button onclick="showUploadModal()" class="btn-primary">+ 上傳證照</button>
        </div>

        <div id="licensesList" class="space-y-4">
            <div class="text-center">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600"></div>
                <p class="mt-4 text-gray-600">載入中...</p>
            </div>
        </div>
    </div>

    <div id="uploadModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">上傳新證照</h3>
                <form id="uploadForm" class="space-y-4">
                    <div>
                        <label for="licenseName" class="block text-sm font-medium text-gray-700 mb-1">
                            證照名稱 <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="licenseName" name="name" required class="input-field"
                            placeholder="例如：照顧服務員技術士證">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="issueDate" class="block text-sm font-medium text-gray-700 mb-1">
                                發證日期 <span class="text-red-500">*</span>
                            </label>
                            <input type="date" id="issueDate" name="issue_date" required class="input-field">
                        </div>

                        <div>
                            <label for="expiryDate" class="block text-sm font-medium text-gray-700 mb-1">
                                有效期限 <span class="text-red-500">*</span>
                            </label>
                            <input type="date" id="expiryDate" name="expiry_date" required class="input-field">
                        </div>
                    </div>

                    <div>
                        <label for="proofFile" class="block text-sm font-medium text-gray-700 mb-1">
                            證照證明文件
                        </label>
                        <input type="file" id="proofFile" name="proof" accept="image/*,.pdf" class="input-field">
                        <p class="text-xs text-gray-500 mt-1">支援圖片或PDF格式</p>
                    </div>

                    <div id="uploadErrorMessage" class="text-red-600 text-sm hidden"></div>

                    <div class="flex justify-end space-x-4">
                        <button type="button" onclick="hideUploadModal()" class="btn-secondary">
                            取消
                        </button>
                        <button type="submit" class="btn-primary">
                            上傳
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="/static/js/api.js"></script>
    <script src="/static/js/navigation.js"></script>
    <script>
        // === 將核心互動函式定義在全域作用域，解決 ReferenceError ===

        /**
         * 顯示上傳 Modal
         * (在 HTML 中被 onclick="showUploadModal()" 呼叫)
         */
        function showUploadModal() {
            document.getElementById('uploadModal').classList.remove('hidden');
            document.getElementById('uploadForm').reset();
        }

        /**
         * 隱藏上傳 Modal
         * (在 HTML 中被 onclick="hideUploadModal()" 呼叫)
         */
        function hideUploadModal() {
            document.getElementById('uploadModal').classList.add('hidden');
            document.getElementById('uploadErrorMessage').classList.add('hidden');
        }

        /**
         * 刪除證照
         * (在 HTML 中被 onclick="deleteLicense(id)" 呼叫)
         */
        async function deleteLicense(licenseId) {
            if (!confirm('確定要刪除此證照嗎？')) return;

            try {
                await licenseAPI.deleteLicense(licenseId);
                showNotification('證照已刪除', 'success');
                loadLicenses();
            } catch (error) {
                showNotification('刪除失敗：' + error.message, 'error');
            }
        }

        // 頁面初始化邏輯和輔助函式可以保留在 IIFE 或全域

        /**
         * 查看許可證圖片（帶認證）
         */
        async function viewLicenseImage(proofUrl) {
            if (!proofUrl) return;
            
            const token = getToken();
            if (!token) {
                showNotification('請先登入', 'error');
                return;
            }

            try {
                // 如果是新的受保護路由，直接使用；如果是舊的 /uploads 路由，轉換為新路由
                let imageUrl = proofUrl;
                if (proofUrl.startsWith('/uploads/licenses/')) {
                    const filename = proofUrl.replace('/uploads/licenses/', '');
                    imageUrl = `${API_BASE_URL}/caregivers/licenses/image/${filename}`;
                } else if (!proofUrl.startsWith('http')) {
                    // 如果已經是相對路徑的 API 路由，加上 API_BASE_URL
                    if (proofUrl.startsWith('/api/v1/')) {
                        imageUrl = `http://localhost:8080${proofUrl}`;
                    } else {
                        imageUrl = `${API_BASE_URL}${proofUrl}`;
                    }
                }

                // 使用 fetch 帶上 token 獲取圖片
                const response = await fetch(imageUrl, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('無法載入圖片');
                }

                // 將響應轉換為 blob 並在新窗口中顯示
                const blob = await response.blob();
                const blobUrl = URL.createObjectURL(blob);
                const newWindow = window.open();
                if (newWindow) {
                    newWindow.document.write(`
                        <html>
                            <head><title>證照圖片</title></head>
                            <body style="margin:0;padding:20px;text-align:center;background:#f0f0f0;">
                                <img src="${blobUrl}" style="max-width:100%;max-height:90vh;border:1px solid #ddd;box-shadow:0 2px 8px rgba(0,0,0,0.1);" />
                            </body>
                        </html>
                    `);
                }
            } catch (error) {
                showNotification('無法載入圖片：' + error.message, 'error');
            }
        }

        // 輔助函式: 顯示證照列表
        function displayLicenses(licenses) {
            const listDiv = document.getElementById('licensesList');

            if (!licenses || licenses.length === 0) {
                listDiv.innerHTML = `
                    <div class="card text-center py-8">
                        <p class="text-gray-600 mb-4">目前沒有證照</p>
                        <button onclick="showUploadModal()" class="btn-primary">上傳第一張證照</button>
                    </div>
                `;
                return;
            }

            const statusColors = {
                'pending': 'bg-yellow-100 text-yellow-800',
                'approved': 'bg-green-100 text-green-800',
                'rejected': 'bg-red-100 text-red-800',
            };

            const statusText = {
                'pending': '審核中',
                'approved': '已通過',
                'rejected': '已拒絕',
            };

            listDiv.innerHTML = licenses.map(license => `
                <div class="card">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3 mb-2">
                                <h3 class="text-xl font-semibold text-gray-800">${license.name}</h3>
                                <span class="px-3 py-1 rounded-full text-sm font-medium ${statusColors[license.status] || 'bg-gray-100 text-gray-800'}">
                                    ${statusText[license.status] || license.status}
                                </span>
                            </div>
                            <div class="text-gray-600 space-y-1">
                                <p><span class="font-medium">發證日期：</span>${formatDate(license.issue_date)}</p>
                                <p><span class="font-medium">有效期限：</span>${formatDate(license.expiry_date)}</p>
                                ${license.proof_url ? `<p><span class="font-medium">證明文件：</span><button onclick="viewLicenseImage('${license.proof_url}')" class="text-primary-600 hover:underline cursor-pointer">查看</button></p>` : ''}
                            </div>
                        </div>
                        ${license.status === 'pending' || license.status === 'rejected' ? `
                            <button onclick="deleteLicense(${license.license_id})" 
                                class="btn-secondary bg-red-500 hover:bg-red-600 text-white ml-4">
                                刪除
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // 輔助函式: 載入證照列表
        async function loadLicenses() {
            try {
                const licenses = await licenseAPI.getMyLicenses();
                displayLicenses(licenses);
            } catch (error) {
                showNotification('載入失敗：' + error.message, 'error');
            }
        }

        // === IIFE: 頁面初始化和事件監聽 ===
        (function () {
            // 授權檢查和頁面初始化邏輯
            if (!requireCaregiverRole()) return;

            // 初始載入資料
            loadLicenses();

            // 上傳表單事件監聽 (不需要暴露到全域，因為它是通過 addEventListener 綁定的)
            document.getElementById('uploadForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const formData = new FormData();
                formData.append('name', document.getElementById('licenseName').value);
                formData.append('issue_date', document.getElementById('issueDate').value);
                formData.append('expiry_date', document.getElementById('expiryDate').value);

                const fileInput = document.getElementById('proofFile');
                if (fileInput.files.length > 0) {
                    formData.append('proof', fileInput.files[0]);
                }

                const errorDiv = document.getElementById('uploadErrorMessage');
                const submitBtn = document.querySelector('#uploadForm button[type="submit"]');

                try {
                    errorDiv.classList.add('hidden');
                    submitBtn.disabled = true;
                    submitBtn.textContent = '上傳中...';

                    await licenseAPI.uploadLicense(formData);
                    showNotification('證照上傳成功！等待審核', 'success');
                    hideUploadModal();
                    loadLicenses();
                } catch (error) {
                    errorDiv.textContent = error.message || '上傳失敗，請稍後再試';
                    errorDiv.classList.remove('hidden');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = '上傳';
                }
            });
        })();
    </script>
</body>

</html>
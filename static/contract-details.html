<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆç´„è©³æƒ… - CareFinder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="/static/css/output.css" rel="stylesheet">
</head>

<body class="bg-gray-50">
    <nav class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-8">
                    <a href="/dashboard.html" class="text-2xl font-bold text-blue-600">CareFinder</a>
                    <div data-nav-menu class="flex space-x-4"></div>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/contracts.html"
                        class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">è¿”å›åˆç´„åˆ—è¡¨</a>
                    <button onclick="authAPI.logout()"
                        class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">ç™»å‡º</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <h2 class="text-3xl font-bold mb-6 text-gray-800">åˆç´„è©³æƒ…</h2>

        <div id="contractDetailsContent" class="space-y-6">
            <div class="text-center py-10">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                <p class="mt-4 text-gray-600">è¼‰å…¥ä¸­...</p>
            </div>
        </div>
    </div>

    <script src="/static/js/api.js"></script>
    <script src="/static/js/navigation.js"></script>
    <script>
        (function () {
            // è¼”åŠ©å‡½æ•¸ï¼šæ ¼å¼åŒ–æ—¥æœŸ
            function formatDate(dateString) {
                if (!dateString) return 'ç„¡è³‡æ–™';
                const date = new Date(dateString);
                return isNaN(date.getTime()) ? 'æ ¼å¼éŒ¯èª¤' : date.toLocaleDateString('zh-TW', {
                    year: 'numeric', month: '2-digit', day: '2-digit'
                });
            }

            if (typeof requireAuth === 'function' && !requireAuth()) return;

            const urlParams = new URLSearchParams(window.location.search);
            const contractId = urlParams.get('id');

            if (!contractId) {
                alert('ç¼ºå°‘åˆç´„ ID');
                window.location.href = '/contracts.html';
                return;
            }

            loadContractDetails(contractId);

            async function loadContractDetails(contractId) {
                try {
                    const contract = await contractAPI.getContract(contractId);

                    // å˜—è©¦å–å¾—ç…§è­·è€…çš„è©³ç´° Profile (å¦‚æœæœ‰çš„è©±ï¼Œç‚ºäº†é¡¯ç¤ºè­‰ç…§ç­‰é¡å¤–è³‡è¨Š)
                    let extraProfile = null;
                    if (contract.caregiver_id) {
                        try {
                            // æ³¨æ„ï¼šé€™è£¡åªç‚ºäº†å–å¾—è­‰ç…§æˆ–ç­è¡¨ç­‰é¡å¤–è³‡è¨Šï¼ŒåŸºæœ¬è³‡è¨Šç”¨ contract è£¡çš„å³å¯
                            extraProfile = await caregiverAPI.getProfile(contract.caregiver_id);
                        } catch (e) {
                            console.log('ç„¡æ³•å–å¾—é¡å¤– Profile è³‡è¨Šï¼Œå°‡ä½¿ç”¨åŸºæœ¬è³‡è¨Š');
                        }
                    }

                    displayContractDetails(contract, extraProfile);
                } catch (error) {
                    console.error(error);
                    alert('è¼‰å…¥å¤±æ•—ï¼š' + error.message);
                }
            }

            function displayContractDetails(contract, extraProfile) {
                const contentDiv = document.getElementById('contractDetailsContent');

                // ä¿®æ­£é‡é» 1ï¼šå„ªå…ˆè®€å–å¤§å¯« Key (User, Caregiver)ï¼Œå¦‚æœæ²’æœ‰æ‰è®€å–å°å¯«
                const caregiverObj = contract.Caregiver || contract.caregiver || {};
                const userObj = contract.User || contract.user || {};

                // é¡å¤–è³‡è¨Šè™•ç†
                const profileData = extraProfile?.profile || extraProfile || {};

                const statusColors = {
                    'pending': 'bg-yellow-100 text-yellow-800',
                    'active': 'bg-green-100 text-green-800',
                    'completed': 'bg-blue-100 text-blue-800',
                    'canceled': 'bg-red-100 text-red-800',
                };

                const statusText = {
                    'pending': 'å¾…æ¥å—',
                    'active': 'é€²è¡Œä¸­',
                    'completed': 'å·²å®Œæˆ',
                    'canceled': 'å·²å–æ¶ˆ',
                };

                // ä¿®æ­£é‡é» 2ï¼šç§»é™¤ .card classï¼Œç›´æ¥ä½¿ç”¨ Tailwind class
                // shadow-md rounded-lg bg-white p-6 æ˜¯åŸºæœ¬æ¨£å¼
                let html = `
                    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-2xl font-semibold mb-2">åˆç´„ #${contract.contract_id}</h3>
                                <span class="px-3 py-1 rounded-full text-sm font-medium ${statusColors[contract.status] || 'bg-gray-100'}">
                                    ${statusText[contract.status] || contract.status}
                                </span>
                                ${contract.is_renewal ? '<span class="ml-2 text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">çºŒç´„</span>' : ''}
                            </div>
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-4 text-gray-700">
                            <div>
                                <p><span class="font-medium">é–‹å§‹æ—¥æœŸï¼š</span>${formatDate(contract.start_date)}</p>
                                <p><span class="font-medium">çµæŸæ—¥æœŸï¼š</span>${formatDate(contract.end_date)}</p>
                            </div>
                            <div>
                                <p><span class="font-medium">åˆç´„æœŸé–“ï¼š</span>${calculateDuration(contract.start_date, contract.end_date)} å¤©</p>
                                <p><span class="font-medium">å»ºç«‹æ™‚é–“ï¼š</span>${formatDate(contract.created_at)}</p>
                            </div>
                        </div>
                    </div>
                `;

                // ç…§è­·è€…å€å¡Š
                // ä¿®æ­£é‡é» 3ï¼šborder-l-4 æ™‚ï¼Œåªä¿ç•™å·¦å´é‚Šæ¡†é¡è‰²ï¼Œä¸åŠ é¡å¤– padding (p-6 å·²ç¶“æœ‰äº†)
                html += `
                    <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-blue-500">
                        <h3 class="text-xl font-semibold mb-4 text-blue-800 flex items-center">
                            <span class="mr-2">ğŸ‘¤</span> ç…§è­·è€…è©³ç´°è³‡æ–™
                        </h3>
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <p><span class="font-medium">æš±ç¨±ï¼š</span>${caregiverObj.nickname || 'æœªæä¾›'}</p>
                                <p><span class="font-medium">é›»å­éƒµä»¶ï¼š</span>${caregiverObj.email || 'æœªæä¾›'}</p>
                                ${profileData.phone ? `<p><span class="font-medium">é›»è©±ï¼š</span>${profileData.phone}</p>` : ''}
                            </div>
                            <div class="flex justify-end">
                                ${caregiverObj.avatar_url ? `<img src="${caregiverObj.avatar_url}" class="w-20 h-20 rounded-full border">` : '<div class="w-20 h-20 bg-gray-200 rounded-full flex items-center justify-center text-xs text-gray-500">ç„¡é ­åƒ</div>'}
                            </div>
                        </div>
                        ${profileData.full_name ? `
                            <div class="mt-4 pt-4 border-t border-gray-100 grid md:grid-cols-2 gap-4 text-sm">
                                <p><span class="font-medium">çœŸå¯¦å§“åï¼š</span>${profileData.full_name}</p>
                                <p><span class="font-medium">æœå‹™è²»ç‡ï¼š</span>NT$ ${profileData.service_rate || 'é¢è­°'}</p>
                            </div>
                        ` : ''}
                    </div>
                `;

                // å®¶å±¬å€å¡Š
                html += `
                    <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-green-500">
                        <h3 class="text-xl font-semibold mb-4 text-green-800 flex items-center">
                            <span class="mr-2">ğŸ </span> å®¶å±¬/é›‡ä¸»è³‡æ–™
                        </h3>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <p><span class="font-medium">æš±ç¨±ï¼š</span>${userObj.nickname || 'æœªæä¾›'}</p>
                                <p><span class="font-medium">è¯çµ¡ä¿¡ç®±ï¼š</span>${userObj.email || 'æœªæä¾›'}</p>
                            </div>
                            <div class="flex justify-end">
                                ${userObj.avatar_url ? `<img src="${userObj.avatar_url}" class="w-16 h-16 rounded-full border">` : '<div class="w-20 h-20 bg-gray-200 rounded-full flex items-center justify-center text-xs text-gray-500">ç„¡é ­åƒ</div>'}
                            </div>
                        </div>
                    </div>
                `;

                // æ“ä½œæŒ‰éˆ•
                const currentUser = typeof getUser === 'function' ? getUser() : {};

                // ç°¡å–®çš„æŒ‰éˆ•æ¨£å¼å®šç¾©
                const btnPrimary = "bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition shadow";
                const btnSecondary = "bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300 transition shadow";

                html += `
                    <div class="flex space-x-4 mt-6">
                        ${contract.status === 'pending' && currentUser.role === 'caregiver' ?
                        `<button onclick="acceptContract(${contract.contract_id})" class="${btnPrimary}">æ¥å—åˆç´„</button>` : ''}
                        
                        ${contract.status === 'active' ?
                        `<button onclick="completeContract(${contract.contract_id})" class="${btnPrimary}">å®Œæˆæœå‹™</button>` : ''}
                        
                        ${contract.status === 'completed' && currentUser.role === 'user' ?
                        `<button onclick="showReviewModal(${contract.contract_id}, ${contract.caregiver_id})" class="${btnPrimary}">ç™¼è¡¨è©•åƒ¹</button>` : ''}
                            
                        <button onclick="window.history.back()" class="${btnSecondary}">è¿”å›</button>
                    </div>
                `;

                contentDiv.innerHTML = html;
            }

            function calculateDuration(start, end) {
                const s = new Date(start);
                const e = new Date(end);
                return Math.ceil(Math.abs(e - s) / (1000 * 60 * 60 * 24)) || 0;
            }

            // API æ“ä½œå‡½æ•¸
            window.acceptContract = async function (id) {
                if (!confirm('ç¢ºèªæ¥å—æ­¤åˆç´„ï¼Ÿ')) return;
                try {
                    await contractAPI.acceptContract(id);
                    alert('åˆç´„å·²æ¥å—ï¼');
                    location.reload();
                } catch (e) { alert(e.message); }
            };

            window.completeContract = async function (id) {
                if (!confirm('ç¢ºèªæœå‹™å·²å®Œæˆï¼Ÿ')) return;
                try {
                    await contractAPI.completeContract(id);
                    alert('æœå‹™å·²æ¨™è¨˜ç‚ºå®Œæˆï¼');
                    location.reload();
                } catch (e) { alert(e.message); }
            };

            // é€™è£¡å¯ä»¥åŠ å…¥ showReviewModal çš„é‚è¼¯...
            window.showReviewModal = function (cId, cgId) {
                alert("è©•åƒ¹åŠŸèƒ½ç¯„ä¾‹ï¼šContract " + cId + ", Caregiver " + cgId);
                // å¯¦éš›å°ˆæ¡ˆå¯é€£æ¥åˆ°æ‚¨çš„ Modal UI
            }

        })();
    </script>
</body>

</html>
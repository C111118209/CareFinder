<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>服務時間設定 - CareFinder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="/static/css/output.css" rel="stylesheet">
</head>

<body class="bg-gray-50 min-h-screen">
    <nav class="bg-white shadow-sm border-b border-gray-100 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-8">
                    <a href="/dashboard.html" class="flex items-center gap-2 text-2xl font-bold text-primary-600">
                        CareFinder
                    </a>
                    <div data-nav-menu class="hidden md:flex space-x-4"></div>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="authAPI.logout()"
                        class="text-gray-500 hover:text-red-600 px-3 py-2 rounded-md text-sm font-medium transition-colors">
                        <i class="fa-solid fa-right-from-bracket"></i> 登出
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">

        <header class="mb-8">
            <h2 class="text-3xl font-bold text-gray-900">服務時間管理</h2>
            <p class="text-gray-500 mt-2">設定您的每週固定行程與特殊日期的排程，讓案主更容易預約。</p>
        </header>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="px-6 py-4 bg-blue-50 border-b border-blue-100 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-100 p-2 rounded-full text-blue-600"><i class="fa-solid fa-calendar-week"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-gray-800">每週固定時間</h3>
                        <p class="text-xs text-blue-600/80">例行性的服務時間</p>
                    </div>
                </div>
                <button type="button" onclick="addAvailabilitySlot()"
                    class="text-sm bg-white border border-blue-200 text-blue-600 px-3 py-1.5 rounded-lg hover:bg-blue-50 transition-colors shadow-sm">
                    <i class="fa-solid fa-plus mr-1"></i> 新增時段
                </button>
            </div>

            <div class="p-6">
                <form id="availabilityForm">
                    <div id="availabilityList" class="space-y-3"></div>

                    <div id="emptyStateWeekly" class="hidden text-center py-8 text-gray-400">
                        <i class="fa-regular fa-calendar-xmark text-4xl mb-2 opacity-50"></i>
                        <p>尚未設定每週時間</p>
                    </div>

                    <div id="errorMessage"
                        class="text-red-600 text-sm mt-4 hidden bg-red-50 p-3 rounded-md border border-red-100"></div>

                    <div class="flex justify-end space-x-3 mt-6 pt-4 border-t border-gray-100">
                        <button type="button" onclick="window.location.reload()"
                            class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg text-sm">取消變更</button>
                        <button type="button" onclick="saveAvailability()"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg text-sm font-medium shadow-sm transition-all">
                            儲存設定
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="px-6 py-4 bg-amber-50 border-b border-amber-100 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-amber-100 p-2 rounded-full text-amber-600"><i class="fa-solid fa-calendar-day"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-gray-800">特殊日期設定</h3>
                        <p class="text-xs text-amber-600/80">優先權高於每週時間（如：國定假日、臨時請假）</p>
                    </div>
                </div>
                <button type="button" onclick="addSpecialAvailabilitySlot()"
                    class="text-sm bg-white border border-amber-200 text-amber-600 px-3 py-1.5 rounded-lg hover:bg-amber-50 transition-colors shadow-sm">
                    <i class="fa-solid fa-plus mr-1"></i> 新增日期
                </button>
            </div>

            <div class="p-6">
                <form id="specialAvailabilityForm">
                    <div id="specialAvailabilityList" class="space-y-3"></div>

                    <div id="emptyStateSpecial" class="hidden text-center py-8 text-gray-400">
                        <i class="fa-solid fa-mug-hot text-4xl mb-2 opacity-50"></i>
                        <p>無特殊排程</p>
                    </div>

                    <div id="specialErrorMessage"
                        class="text-red-600 text-sm mt-4 hidden bg-red-50 p-3 rounded-md border border-red-100"></div>

                    <div class="flex justify-end space-x-3 mt-6 pt-4 border-t border-gray-100">
                        <button type="button" onclick="window.location.reload()"
                            class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg text-sm">取消變更</button>
                        <button type="button" onclick="saveSpecialAvailability()"
                            class="bg-amber-500 hover:bg-amber-600 text-white px-5 py-2 rounded-lg text-sm font-medium shadow-sm transition-all">
                            儲存特殊時段
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="/static/js/api.js"></script>
    <script src="/static/js/navigation.js"></script>

    <script>
        let availabilityCount = 0;
        let specialAvailabilityCount = 0;

        // 更新 UI 狀態 (當列表為空時顯示 Empty State)
        function updateUIState() {
            const list = document.getElementById('availabilityList');
            const empty = document.getElementById('emptyStateWeekly');
            if (list.children.length === 0) {
                empty.classList.remove('hidden');
            } else {
                empty.classList.add('hidden');
            }

            const sList = document.getElementById('specialAvailabilityList');
            const sEmpty = document.getElementById('emptyStateSpecial');
            if (sList.children.length === 0) {
                sEmpty.classList.remove('hidden');
            } else {
                sEmpty.classList.add('hidden');
            }
        }

        function addAvailabilitySlot(dayOfWeek = '', startTime = '', endTime = '') {
            const list = document.getElementById('availabilityList');
            const slot = document.createElement('div');
            // 優化後的卡片樣式
            slot.className = 'slot-card group flex flex-wrap md:flex-nowrap items-center gap-3 p-3 bg-white border border-gray-200 rounded-lg hover:border-blue-300';
            slot.id = `slot-${availabilityCount}`;

            slot.innerHTML = `
                <div class="w-full md:w-auto md:flex-1 grid grid-cols-2 md:grid-cols-4 gap-3 items-center">
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs text-gray-500 md:hidden mb-1">星期</label>
                        <div class="relative">
                            <i class="fa-solid fa-calendar absolute left-2 top-2.5 text-gray-400 text-sm"></i>
                            <select name="day_of_week" class="input-mini pl-7 bg-gray-50 focus:bg-white focus:ring-1 focus:ring-blue-500" required>
                                <option value="">選擇星期</option>
                                <option value="1" ${dayOfWeek === 1 ? 'selected' : ''}>週一</option>
                                <option value="2" ${dayOfWeek === 2 ? 'selected' : ''}>週二</option>
                                <option value="3" ${dayOfWeek === 3 ? 'selected' : ''}>週三</option>
                                <option value="4" ${dayOfWeek === 4 ? 'selected' : ''}>週四</option>
                                <option value="5" ${dayOfWeek === 5 ? 'selected' : ''}>週五</option>
                                <option value="6" ${dayOfWeek === 6 ? 'selected' : ''}>週六</option>
                                <option value="7" ${dayOfWeek === 7 ? 'selected' : ''}>週日</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="md:col-span-3 flex items-center gap-2">
                        <div class="flex-1">
                            <label class="block text-xs text-gray-500 md:hidden mb-1">開始</label>
                            <input type="time" name="start_time" class="input-mini" required value="${startTime}">
                        </div>
                        <span class="text-gray-400 mt-5 md:mt-0"><i class="fa-solid fa-arrow-right text-xs"></i></span>
                        <div class="flex-1">
                            <label class="block text-xs text-gray-500 md:hidden mb-1">結束</label>
                            <input type="time" name="end_time" class="input-mini" required value="${endTime}">
                        </div>
                    </div>
                </div>

                <div class="w-full md:w-auto flex justify-end md:border-l md:pl-3 border-gray-100">
                    <button type="button" onclick="removeSlot('slot-${availabilityCount}')" 
                        class="text-gray-400 hover:text-red-500 hover:bg-red-50 p-2 rounded-full transition-colors" title="刪除">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                </div>
            `;

            list.appendChild(slot);
            availabilityCount++;
            updateUIState();
        }

        function removeSlot(slotId) {
            const slot = document.getElementById(slotId);
            if (slot) {
                // Add a fading effect before removing
                slot.style.opacity = '0';
                setTimeout(() => {
                    slot.remove();
                    updateUIState();
                }, 200);
            }
        }

        async function saveAvailability() {
            const slots = document.querySelectorAll('[id^="slot-"]');
            const availabilities = [];

            for (const slot of slots) {
                const dayOfWeek = slot.querySelector('[name="day_of_week"]').value;
                const startTime = slot.querySelector('[name="start_time"]').value;
                const endTime = slot.querySelector('[name="end_time"]').value;

                if (!dayOfWeek || !startTime || !endTime) continue;

                if (startTime >= endTime) {
                    showNotification('開始時間必須早於結束時間', 'error');
                    return;
                }

                availabilities.push({
                    day_of_week: parseInt(dayOfWeek),
                    start_time: startTime,
                    end_time: endTime,
                });
            }

            // 允許清空所有時間 (視需求而定，這裡保留原邏輯但優化提示)
            if (availabilities.length === 0 && slots.length > 0) {
                showNotification('請完整填寫時間段資訊', 'error');
                return;
            }

            const errorDiv = document.getElementById('errorMessage');

            try {
                errorDiv.classList.add('hidden');
                await caregiverAPI.updateAvailability(availabilities);
                showNotification('每週服務時間已更新！', 'success');
                window.location.reload();
            } catch (error) {
                errorDiv.textContent = error.message || '儲存失敗';
                errorDiv.classList.remove('hidden');
            }
        }

        function addSpecialAvailabilitySlot(date = '', startTime = '', endTime = '', isAvailable = true) {
            const list = document.getElementById('specialAvailabilityList');
            const slot = document.createElement('div');
            // 特殊時段使用 Amber 色系邊框 Hover
            slot.className = 'slot-card group flex flex-wrap md:flex-nowrap items-center gap-3 p-3 bg-white border border-gray-200 rounded-lg hover:border-amber-300 border-l-4 border-l-amber-400';
            slot.id = `special-slot-${specialAvailabilityCount}`;

            const dateValue = date ? (typeof date === 'string' ? date.split('T')[0] : date) : '';

            slot.innerHTML = `
                <div class="w-full md:w-auto md:flex-1 grid grid-cols-2 md:grid-cols-10 gap-3 items-center">
                    <div class="col-span-2 md:col-span-3">
                        <label class="block text-xs text-gray-500 md:hidden mb-1">日期</label>
                        <input type="date" name="date" class="input-mini bg-gray-50 focus:bg-white" required value="${dateValue}">
                    </div>

                    <div class="col-span-2 md:col-span-4 flex items-center gap-2">
                        <div class="flex-1">
                            <label class="block text-xs text-gray-500 md:hidden mb-1">開始</label>
                            <input type="time" name="start_time" class="input-mini" required value="${startTime}">
                        </div>
                        <span class="text-gray-400 mt-5 md:mt-0"><i class="fa-solid fa-arrow-right text-xs"></i></span>
                        <div class="flex-1">
                            <label class="block text-xs text-gray-500 md:hidden mb-1">結束</label>
                            <input type="time" name="end_time" class="input-mini" required value="${endTime}">
                        </div>
                    </div>

                    <div class="col-span-2 md:col-span-3">
                        <label class="block text-xs text-gray-500 md:hidden mb-1">狀態</label>
                        <select name="is_available" class="input-mini ${isAvailable ? 'text-green-600 font-medium' : 'text-red-500 font-medium'}" onchange="this.className = this.value === 'true' ? 'input-mini text-green-600 font-medium' : 'input-mini text-red-500 font-medium'" required>
                            <option value="true" ${isAvailable ? 'selected' : ''}>✅ 可服務</option>
                            <option value="false" ${!isAvailable ? 'selected' : ''}>⛔ 不可服務</option>
                        </select>
                    </div>
                </div>

                <div class="w-full md:w-auto flex justify-end md:border-l md:pl-3 border-gray-100">
                    <button type="button" onclick="removeSpecialSlot('special-slot-${specialAvailabilityCount}')" 
                        class="text-gray-400 hover:text-red-500 hover:bg-red-50 p-2 rounded-full transition-colors" title="刪除">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                </div>
            `;

            list.appendChild(slot);
            specialAvailabilityCount++;
            updateUIState();
        }

        function removeSpecialSlot(slotId) {
            const slot = document.getElementById(slotId);
            if (slot) {
                slot.style.opacity = '0';
                setTimeout(() => {
                    slot.remove();
                    updateUIState();
                }, 200);
            }
        }

        async function saveSpecialAvailability() {
            const slots = document.querySelectorAll('[id^="special-slot-"]');
            const specialAvailabilities = [];

            for (const slot of slots) {
                const date = slot.querySelector('[name="date"]').value;
                const startTime = slot.querySelector('[name="start_time"]').value;
                const endTime = slot.querySelector('[name="end_time"]').value;
                const isAvailable = slot.querySelector('[name="is_available"]').value === 'true';

                if (!date || !startTime || !endTime) continue;

                if (startTime >= endTime) {
                    showNotification('開始時間必須早於結束時間', 'error');
                    return;
                }

                specialAvailabilities.push({
                    date: date,
                    start_time: startTime,
                    end_time: endTime,
                    is_available: isAvailable,
                });
            }

            const errorDiv = document.getElementById('specialErrorMessage');

            try {
                errorDiv.classList.add('hidden');
                await caregiverAPI.updateSpecialAvailability(specialAvailabilities);
                showNotification('特殊時段已更新！', 'success');
                window.location.reload();
            } catch (error) {
                errorDiv.textContent = error.message || '儲存失敗';
                errorDiv.classList.remove('hidden');
            }
        }

        async function loadAvailability() {
            try {
                const response = await caregiverAPI.getAvailability();
                const availabilities = response.availabilities || [];
                const list = document.getElementById('availabilityList');
                list.innerHTML = '';

                if (availabilities.length > 0) {
                    availabilities.forEach(avail => {
                        addAvailabilitySlot(avail.day_of_week, avail.start_time, avail.end_time);
                    });
                }
                updateUIState(); // 更新空狀態顯示
            } catch (error) {
                console.error('載入失敗:', error);
                updateUIState();
            }
        }

        async function loadSpecialAvailability() {
            try {
                const response = await caregiverAPI.getSpecialAvailability();
                const specialAvailabilities = response.special_availabilities || [];
                const list = document.getElementById('specialAvailabilityList');
                list.innerHTML = '';

                if (specialAvailabilities.length > 0) {
                    specialAvailabilities.forEach(avail => {
                        const dateStr = avail.date ? (typeof avail.date === 'string' ? avail.date : avail.date.split('T')[0]) : '';
                        addSpecialAvailabilitySlot(dateStr, avail.start_time, avail.end_time, avail.is_available);
                    });
                }
                updateUIState(); // 更新空狀態顯示
            } catch (error) {
                console.error('載入特殊時段失敗:', error);
                updateUIState();
            }
        }

        (function () {
            if (!requireCaregiverRole()) return;
            loadAvailability();
            loadSpecialAvailability();
        })();
    </script>
</body>

</html>
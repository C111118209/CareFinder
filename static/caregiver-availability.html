<!DOCTYPE html>
<html lang="zh-TW">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>服務時間設定 - CareFinder</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link href="/static/css/output.css" rel="stylesheet">
</head>

<body class="bg-gray-50">
    <nav class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-8">
                    <a href="/dashboard.html" class="text-2xl font-bold text-primary-600">CareFinder</a>
                    <div data-nav-menu class="flex space-x-4">
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="authAPI.logout()"
                        class="text-gray-700 hover:text-primary-600 px-3 py-2 rounded-md text-sm font-medium">登出</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <h2 class="text-3xl font-bold mb-6 text-gray-800">可服務時間設定</h2>

        <div class="card mb-6">
            <p class="text-gray-600 mb-4">請設定您每週可提供服務的時間段。使用者將根據這些時間來搜尋和發起合約。</p>
        </div>

        <div class="card">
            <form id="availabilityForm">
                <div id="availabilityList" class="space-y-4">
                </div>

                <div class="mt-6">
                    <button type="button" onclick="addAvailabilitySlot()" class="btn-secondary">
                        + 新增時間段
                    </button>
                </div>

                <div id="errorMessage" class="text-red-600 text-sm mt-4 hidden"></div>

                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" onclick="window.location.reload()" class="btn-secondary">
                        取消
                    </button>
                    <button type="button" onclick="saveAvailability()" class="btn-primary">
                        儲存
                    </button>
                </div>
            </form>
        </div>
    </div>


    <script src="/static/js/api.js"></script>

    <script src="/static/js/navigation.js"></script>

    <script>
        // === 將核心函數定義在全域作用域，解決 ReferenceError ===
        // 這些函數需要在 HTML 中被 onclick 調用，所以必須定義在全域作用域
        let availabilityCount = 0;

        /**
         * 新增時間段 slot
         * (在 HTML 中被 onclick="addAvailabilitySlot()" 呼叫)
         */
        function addAvailabilitySlot(dayOfWeek = '', startTime = '', endTime = '') {
            const list = document.getElementById('availabilityList');
            const slot = document.createElement('div');
            slot.className = 'border border-gray-200 rounded-lg p-4 bg-gray-50';
            slot.id = `slot-${availabilityCount}`;

            slot.innerHTML = `
        <div class="grid md:grid-cols-4 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">星期</label>
            <select name="day_of_week" class="input-field" required>
              <option value="">請選擇</option>
              <option value="1" ${dayOfWeek === 1 ? 'selected' : ''}>週一</option>
              <option value="2" ${dayOfWeek === 2 ? 'selected' : ''}>週二</option>
              <option value="3" ${dayOfWeek === 3 ? 'selected' : ''}>週三</option>
              <option value="4" ${dayOfWeek === 4 ? 'selected' : ''}>週四</option>
              <option value="5" ${dayOfWeek === 5 ? 'selected' : ''}>週五</option>
              <option value="6" ${dayOfWeek === 6 ? 'selected' : ''}>週六</option>
              <option value="7" ${dayOfWeek === 7 ? 'selected' : ''}>週日</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">開始時間</label>
            <input type="time" name="start_time" class="input-field" required value="${startTime}">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">結束時間</label>
            <input type="time" name="end_time" class="input-field" required value="${endTime}">
          </div>
          <div class="flex items-end">
            <button type="button" onclick="removeSlot('slot-${availabilityCount}')" 
              class="btn-secondary w-full bg-red-500 hover:bg-red-600 text-white">
              刪除
            </button>
          </div>
        </div>
      `;

            list.appendChild(slot);
            availabilityCount++;
        }

        /**
         * 刪除時間段 slot
         * (在動態生成的 HTML 中被 onclick="removeSlot('slot-xxx')" 呼叫)
         */
        function removeSlot(slotId) {
            const slot = document.getElementById(slotId);
            if (slot) {
                slot.remove();
            }
        }

        /**
         * 儲存服務時間
         * (在 HTML 中被 onclick="saveAvailability()" 呼叫)
         */
        async function saveAvailability() {
            const slots = document.querySelectorAll('[id^="slot-"]');
            const availabilities = [];

            for (const slot of slots) {
                const dayOfWeek = slot.querySelector('[name="day_of_week"]').value;
                const startTime = slot.querySelector('[name="start_time"]').value;
                const endTime = slot.querySelector('[name="end_time"]').value;

                if (!dayOfWeek || !startTime || !endTime) {
                    continue; // Skip incomplete slots
                }

                if (startTime >= endTime) {
                    showNotification('開始時間必須早於結束時間', 'error');
                    return;
                }

                availabilities.push({
                    day_of_week: parseInt(dayOfWeek),
                    start_time: startTime,
                    end_time: endTime,
                });
            }

            if (availabilities.length === 0) {
                showNotification('請至少設定一個時間段', 'error');
                return;
            }

            const errorDiv = document.getElementById('errorMessage');

            try {
                errorDiv.classList.add('hidden');
                await caregiverAPI.updateAvailability(availabilities);
                showNotification('服務時間已更新！', 'success');
                window.location.reload();
            } catch (error) {
                errorDiv.textContent = error.message || '儲存失敗，請稍後再試';
                errorDiv.classList.remove('hidden');
            }
        }

        // === 輔助函數（不需要暴露到全域，但為了代碼組織放在這裡）===
        /**
         * 載入現有的 availability
         * (只在頁面初始化時調用，不需要暴露到全域)
         */
        async function loadAvailability() {
            try {
                const response = await caregiverAPI.getAvailability();
                const availabilities = response.availabilities || [];

                const list = document.getElementById('availabilityList');
                list.innerHTML = ''; // 清空現有內容

                if (availabilities.length > 0) {
                    // 載入現有的 availability
                    availabilities.forEach(avail => {
                        addAvailabilitySlot(avail.day_of_week, avail.start_time, avail.end_time);
                    });
                } else {
                    // 如果沒有現有的 availability，添加一個空的 slot
                    addAvailabilitySlot();
                }
            } catch (error) {
                console.error('載入服務時間失敗:', error);
                // 即使載入失敗，也添加一個空的 slot
                if (document.getElementById('availabilityList').children.length === 0) {
                    addAvailabilitySlot();
                }
            }
        }

        // === IIFE: 頁面初始化邏輯 ===
        // 使用 IIFE 包裹頁面初始化邏輯，解決 Illegal return statement 錯誤
        // 只有初始化邏輯包在 IIFE 中，需要被 HTML 調用的函數都定義在全域
        (function () {
            if (!requireCaregiverRole()) return;

            // 載入現有的 availability
            loadAvailability();
        })();
    </script>
</body>

</html>